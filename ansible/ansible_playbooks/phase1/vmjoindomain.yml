---
- hosts: all
  gather_facts: false
  tasks:
    - add_host: 
        host: '{{target_machine}}'
      when: target_machine is defined  
# This play is performed to validate and run initial configuration of the Hyperv
- name: validate and configure the hyperv
  hosts: '{{target_machine | default("all")}}'
  gather_facts: false
  vars_files:
    - joinvm_vault.yml
  vars:
    ansible_connection: winrm
    ansible_winrm_server_cert_validation: ignore
    ansible_ssh_port: 5986
    # ansible_winrm_transport: ntlm
  tasks:
   - name: Join computer to domain
     win_domain_membership:
       dns_domain_name: stp.local
       domain_admin_user: '{{ admin_user }}'
       domain_admin_password: '{{ admin_pass }}'
       domain_ou_path: "OU=Retail OMS App Servers,OU=Retail,OU=Servers,DC=STP,DC=LOCAL"
       state: domain
     register: domain_state
   - win_reboot:
     when: domain_state.reboot_required
