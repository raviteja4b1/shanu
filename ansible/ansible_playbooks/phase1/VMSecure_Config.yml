---
- hosts: all
  gather_facts: false
  tasks:
    - add_host: 
        host: '{{target_machine}}'
      when: target_machine is defined  
#This Play is used for server hardening
- name: Server Hardening
  hosts: '{{target_machine | default("all")}}'
  vars_files:
    - phase1_vault.yml
  vars:
    ansible_connection: winrm
    ansible_winrm_server_cert_validation: ignore
    ansible_ssh_port: 5986
    ansible_winrm_transport: ntlm
  tasks:              
      - name: copy cryptoCli.exe
        win_copy:
          src: "{{ item }}"
          dest: C:\tmp\
          remote_src: True
        become: True
        become_method: runas
        become_flags: logon_type=new_credentials logon_flags=netcredentials_only 
        loop: 
            - \\stp-it227\IT\Retail Stores\Powershell_Scripts\Assets\cryptoCli.exe
            - \\stp-it227\IT\Retail Stores\Powershell_Scripts\Assets\SierraDefaults.ictpl         
            - \\stp-it227\IT\Crowdstrike\WindowsSensor.exe
            - \\stp-it227\IT\Retail Stores\Documentation\SCCM\ccmsetup.exe

      - name: execute WindowsSensor
        win_command: C:\tmp\WindowsSensor.exe /install /quiet /norestart CID=FAA122281AE74AC99A41598A35C684B2-18
        register: output_WindowsSensor
      
      - name: execute cryptoCli
        win_command: C:\tmp\cryptoCli.exe /template C:\tmp\SierraDefaults.ictpl
        register: output_cryptoCli
      
      - name: execute ccmsetup
        win_command: C:\tmp\ccmsetup.exe /mp:stp-sccmmp81.stp.local SMSMP= sccmmp81.stp.local SMSSITECODE=STP
        register: output_CCMSETUP
        
      - name: debug execute ccmsetup
        debug:
          msg: "SCCM successfully installed. Be sure to create a ticket notifying Cognizant and others that SCCM has been added."