---
- hosts: all
  gather_facts: false
  tasks:
    - add_host: 
        host: "{{target_machine}}"
      when: target_machine is defined 
- name: Configure New App
  hosts: "{{target_machine | default('all') }}"
  gather_facts: false
  vars_files:
    - ../phase1/phase1_vault.yml
  vars:
    ansible_connection: winrm
    ansible_winrm_server_cert_validation: ignore
    ansible_ssh_port: 5986
    ansible_winrm_transport: ntlm 
  tasks: 
    - name: Install Oms Retail Server Deployments
      win_package:
        path: C:\OmsUtilities\InstallScripts\{{item}}
        productid: auto
        arguments: /package
        state: present
      loop: 
        - CopyOmsRetailServerDeployments.bat
        - OmsRetailServerDeployments.bat  
    - name: Read Ver text
      win_shell: 'type \\stp-retapp151\C$\OMS\Oms.RetailWebService\Ver.txt'  
      register: OMSVersion
      become: true
      become_method: runas
    - debug: 
        msg: '{{OMSVersion.stdout_lines[0]}}'
      
    - name: Install OMS and omsutilities services
      win_package:
        path: C:\{{item}}
        arguments: /c
        creates_path: C:\{{item}}
        creates_version: "{{ OMSVersion.stdout_lines[0] }}"
        productid: auto
        state: present
      when: OMSVersion.stdout_lines is defined
      become: true
      become_method: runas
      loop:
        - OMS\InstallRetailServerCopyOnly.bat
        - OMS\InstallRetailServerInstallOnly.bat
        - OmsUtilities\InstallScripts\RetailFrameworkPrepare.bat
        - OmsUtilities\InstallScripts\RetailFrameworkFinalize.bat
      
    - name: instal Prepare & Finalize PromoService
      win_package:
        path: C:\OMSUtilities\PromoServiceDeploymentScripts\{{item}}
        arguments: /c
        productid: auto
        state: present
      become: true
      become_method: runas
      loop:
        - PreparePromoService_Retail.bat
        - FinalizePromoService.bat
