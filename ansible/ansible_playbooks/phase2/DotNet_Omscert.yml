---
- hosts: all
  gather_facts: false
  tasks:
    - add_host: 
        host: '{{target_machine}}'
      when: target_machine is defined 
- name: Configuring APP server
  hosts: '{{target_machine | default("all")}}'
  gather_facts: false
  vars_files:
    - ../phase1/phase1_vault.yml
  vars:
    ansible_connection: winrm
    ansible_winrm_server_cert_validation: ignore
    ansible_ssh_port: 5986
    ansible_winrm_transport: ntlm
  tasks:
    - name: Download .net framework 4.8
      win_get_url:
        url: https://download.visualstudio.microsoft.com/download/pr/014120d7-d689-4305-befd-3cb711108212/1f81f3962f75eff5d83a60abd3a3ec7b/ndp48-web.exe
        dest: C:\Temp\ndp48-web.exe
    - name: install .NET
      win_package:
        path: C:\Temp\ndp48-web.exe
        arguments: /q
        productid: auto
        state: present
        
    - name: get netVersion
      win_reg_stat:
        path: HKLM:\SOFTWARE\Microsoft\NET Framework Setup\NDP\v4\Full
        name: Release
      register: installedNetVersion
      failed_when: ( installedNetVersion.value < 528040)
    - debug:
        msg: ".NET was installed succesfully. Proceeding with setup"
      when: ( installedNetVersion.value >= 528040 ) 
    
    - name: Copy OMS certificates
      win_copy:
        src: certs/AppOmsRetail.pfx
        dest: C:\Temp\AppOmsRetail.pfx
    # CJ's will check Tim for installation    
    # - name: Installing app OMS retail cert
    #   win_shell:
    #     Import-PfxCertificate -FilePath "c:\Temp\AppOmsRetail.pfx" -CertStoreLocation Cert:\LocalMachine\My -Password $credOms.Password  
    #   register: instAppOmsCert
    # - debug: 
    #     msg: '{{instAppOmsCert}}'
          
